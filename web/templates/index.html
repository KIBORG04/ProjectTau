<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "header.html" .}}

<div class="container mt-4">
    {{ template "ad.html" . }}
    <div class="row">
        <div class="col-sm-3 col-lg-4">
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Версия статистики: {{ .version }}</li>
                <li class="list-group-item">Дата начала сбора статистики: {{ .firstDate }}</li>
                <li class="list-group-item">Последнее обновление БД: {{ .lastDate }}</li>
                <li class="list-group-item">Последний раунд в БД: {{ .lastRound }}</li>
            </ul>
        </div>
        <div class="col-sm-3 col-lg-4">
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Раундов в статистике: {{ .totalRounds }}</li>
                <li class="list-group-item">Раундов на первом: {{ .alphaRounds }}</li>
                <li class="list-group-item">Раундов на втором: {{ .betaRounds }}</li>
                <li class="list-group-item">Раундов на третьем: {{ .gammaRounds }}</li>
                <button class="btn btn-outline-secondary mt-5" type="button" data-bs-toggle="collapse"
                        data-bs-target="#crewDeathsSum"
                        aria-expanded="false" aria-controls="collapseExample">
                    Смертей экипажа: {{ .crewDeathsSum }}
                </button>
                <div class="collapse" id="crewDeathsSum">
                    {{ range .crewDeathsCount }}
                        <li class="list-group-item ps-3 pt-0 pb-0">{{ .Name }}: {{ .Count }}</li>
                    {{ end }}
                </div>
                <button class="btn btn-outline-secondary  mt-5" type="button" data-bs-toggle="collapse"
                        data-bs-target="#roleDeathsSum"
                        aria-expanded="false" aria-controls="collapseExample">
                    Смертей ролей: {{ .roleDeathsSum }}
                </button>
                <div class="collapse" id="roleDeathsSum">
                    {{ range .roleDeathsCount }}
                        <li class="list-group-item ps-3 pt-0 pb-0">{{ .Name }}: {{ .Count }}</li>
                    {{ end }}
                </div>
                <ul class="list-group list-group-flush  mt-5">
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#modesSum"
                            aria-expanded="false" aria-controls="collapseExample">
                        Количество режимов: {{ .modesSum }}
                    </button>
                    <div class="collapse" id="modesSum">
                        {{ range .modesCount }}
                            <li class="list-group-item ps-3 pt-0 pb-0">{{ .Name }}: {{ .Count }}</li>
                        {{ end }}
                    </div>
                </ul>
            </ul>
        </div>
        <div class="col-sm-3 col-lg-4 mt-2">
            <ul class="list-group list-group-flush">
                <div id="random_announce">
                    <div class="spinner-border text-end" role="status"></div>
                </div>

                <div id="random_achievement">
                    <div class="spinner-border text-end" role="status"></div>
                </div>

                <div id="random_flavor">
                    <div class="spinner-border text-end" role="status"></div>
                </div>

                <div id="random_last_phrase">
                    <div class="spinner-border text-end" role="status"></div>
                </div>
            </ul>
        </div>
    </div>
</div>

<!--Embed the footer.html template at this location-->
{{ template "footer.html" .}}

<script>
    function unescape(str) {
        return str.replace(/&amp;#34;/g, '"')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'")
    }

    function get_announce() {
        $.getJSON("/api/random_announce", function (data) {
            const author = data.Author ? `<figcaption class="blockquote-footer">${data.Author}</figcaption>` : ""
            const button = `<button id="update_announce" class="btn btn-outline-secondary btn-sm bi bi-arrow-clockwise float-md-end ms-2"></button>`
            $("#random_announce").html(`
             <figure class="text-end">
                        <p class="h5">${button}${data.Title}</p>
                        <p id="announce_contents" class="fs-6"></p>
                         ${author}
             </figure>`)
            $("#announce_contents").text(unescape(data.Content))
            $("#update_announce").click(get_announce)
        })
    }

    function get_achievement() {
        $.getJSON("/api/random_achievement", function (data) {
            const button = `<button id="update_achievement" class="btn btn-outline-secondary btn-sm bi bi-arrow-clockwise float-md-end ms-2"></button>`
            $("#random_achievement").html(`
             <figure class="text-end">
                        <p class="h5">${button}${data.Title}</p>
                        <p id="achievement_contents" class="fs-6"></p>
                        <figcaption class="blockquote-footer">
                            ${data.Key} as ${data.Name}
                        </figcaption>
             </figure>`)
            $("#achievement_contents").text(unescape(data.Desc))
            $("#update_achievement").click(get_achievement)
        })
    }

    function get_flavor() {
        $.getJSON("/api/random_flavor", function (data) {
            const button = `<button id="update_flavor" class="btn btn-outline-secondary btn-sm bi bi-arrow-clockwise float-md-end ms-2"></button>`
            $("#random_flavor").html(`
             <figure class="text-end">
                        <p class="h5">${button}${data.Name}</p>
                        <p id="flavor_contents" class="fs-6"></p>
                        <figcaption class="blockquote-footer" style="text-transform:capitalize;">
                            ${data.Gender}, ${data.Age}, ${data.Species}
                        </figcaption>
             </figure>`)
            $("#flavor_contents").text(unescape(data.Flavor))
            $("#update_flavor").click(get_flavor)
        })
    }

    function get_last_phrase() {
        $.getJSON("/api/random_last_phrase", function (data) {
            const button = `<button id="update_last_phrase" class="btn btn-outline-secondary btn-sm bi bi-arrow-clockwise float-md-end ms-2"></button>`
            $("#random_last_phrase").html(`
             <figure class="text-end">
                        <p class="h5">${button}Перед смертью в ${data.TimeOfDeath}</p>
                        <p class="fs-6"><span style='font-weight: 500;'>${data.Name}</span>: "${data.Phrase}"</p>
                        <figcaption class="blockquote-footer">
                            Round #${data.RoundID}
                        </figcaption>
             </figure>`)
            $("#update_last_phrase").click(get_last_phrase)
        })
    }

    get_announce()
    get_achievement()
    get_last_phrase()
    get_flavor()

</script>